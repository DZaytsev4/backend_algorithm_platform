name: Users Comprehensive Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'users/**'
      - 'backend/users/**'
      - 'algorithms/**'  # –ù—É–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞–ª–≥–æ—Ä–∏—Ç–º—ã
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      detailed_report:
        description: 'Generate detailed coverage report'
        type: boolean
        default: false

jobs:
  run-all-users-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage pytest-django
    
    - name: Run migrations
      run: |
        cd backend
        python manage.py migrate
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Run All 25 Users Tests
      id: run-tests
      run: |
        cd backend
        echo "Running all 25 users tests..."
        python manage.py test users.tests --verbosity=2
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞
        echo "total_tests=25" >> $GITHUB_OUTPUT
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Generate Detailed Coverage Report
      if: github.event.inputs.detailed_report == 'true' || failure()
      run: |
        cd backend
        pip install coverage
        coverage run --source='./users' manage.py test users.tests
        coverage xml
        coverage report
        coverage html
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ —Ñ–∞–π–ª–∞–º
        echo "=== Coverage by file ==="
        coverage report --show-missing
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Upload Coverage Reports
      if: github.event.inputs.detailed_report == 'true' || failure()
      uses: actions/upload-artifact@v4
      with:
        name: users-comprehensive-coverage
        path: |
          backend/coverage.xml
          backend/htmlcov/
        retention-days: 30
    
    - name: Run Security Scan
      if: always()
      run: |
        pip install bandit
        bandit -r users/ -f html -o users-security-scan.html -ll
        echo "Security scan completed"
    
    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: users-security-scan
        path: users-security-scan.html
        retention-days: 15
    
    - name: Test Results Summary
      if: always()
      run: |
        echo "=== USERS TESTS SUMMARY ==="
        echo "Total tests executed: ${{ steps.run-tests.outputs.total_tests }}"
        echo "Test suite: UserViewsTests, UserFormsTests, UserSerializersTests"
        echo "Python version: 3.10"
        echo "Database: PostgreSQL"
        echo "==========================="
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "üéâ All 25 users tests passed successfully!"
          echo "‚úÖ Registration tests (4 tests)"
          echo "‚úÖ Authentication tests (2 tests)" 
          echo "‚úÖ User search tests (3 tests)"
          echo "‚úÖ Profile tests (3 tests)"
          echo "‚úÖ Algorithms access tests (6 tests)"
          echo "‚úÖ Form tests (3 tests)"
          echo "‚úÖ Serializer tests (4 tests)"
        else
          echo "‚ùå Some tests failed. Check the logs for details."
        fi
    
    - name: Create Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: users-test-execution-report
        path: |
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          backend/test-reports/
        retention-days: 7

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: run-all-users-tests
    if: failure()
    
    steps:
    - name: Notify Test Failure
      run: |
        echo "Users comprehensive tests failed!"
        echo "Workflow: ${{ github.workflow }}"
        echo "Commit: ${{ github.sha }}"
        echo "Please check the test logs for details."
      # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Slack, Email –∏ —Ç.–¥.